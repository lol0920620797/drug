<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>藥物清單管理系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>

<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">💊 藥物清單管理系統</h1>

    <!-- 搜尋 -->
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="🔍 請輸入藥名進行搜尋" oninput="renderDrugs()">
    </div>

    <!-- 新增表單 -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4"><input type="text" id="name" class="form-control" placeholder="藥名"></div>
          <div class="col-md-4"><input type="text" id="indication" class="form-control" placeholder="適應症"></div>
          <div class="col-md-4"><input type="text" id="sideEffect" class="form-control" placeholder="副作用"></div>
          <div class="col-md-6"><input type="text" id="specialInstruction" class="form-control" placeholder="特殊用藥指示"></div>
          <div class="col-md-6"><input type="text" id="storage" class="form-control" placeholder="藥物保存方式"></div>
          <div class="col-md-12"><input type="text" id="emergencyGuideline" class="form-control" placeholder="應急就醫時機"></div>
          <div class="col-md-12 d-grid"><button class="btn btn-primary" onclick="addDrug()">新增藥物</button></div>
        </div>
      </div>
    </div>

    <!-- 清單 -->
    <ul class="list-group" id="drugList"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBI6nbcytrLY15EUi8CBVGDK6GNlgPhSD4",
      authDomain: "druglistapp-9590d.firebaseapp.com",
      projectId: "druglistapp-9590d",
      storageBucket: "druglistapp-9590d.appspot.com",
      messagingSenderId: "779715592474",
      appId: "1:779715592474:web:e83197b85f06afab90aca3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const drugsRef = db.collection("drugs");

    let drugCache = [];

    function addDrug() {
      const data = {
        name: document.getElementById("name").value.trim(),
        indication: document.getElementById("indication").value.trim(),
        sideEffect: document.getElementById("sideEffect").value.trim(),
        specialInstruction: document.getElementById("specialInstruction").value.trim(),
        storage: document.getElementById("storage").value.trim(),
        emergencyGuideline: document.getElementById("emergencyGuideline").value.trim()
      };

      for (let key in data) {
        if (!data[key]) {
          return Swal.fire("欄位未填", "請完整填寫所有欄位", "warning");
        }
      }

      drugsRef.add(data).then(() => {
        clearForm();
        Swal.fire("新增成功", "藥物資料已加入清單", "success");
      });
    }

    function clearForm() {
      ["name", "indication", "sideEffect", "specialInstruction", "storage", "emergencyGuideline"].forEach(id => {
        document.getElementById(id).value = "";
      });
    }

    function renderDrugs() {
      const list = document.getElementById("drugList");
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      list.innerHTML = "";

      drugCache
        .filter(doc => doc.data.name.toLowerCase().includes(keyword))
        .forEach(doc => {
          const d = doc.data;
          const li = document.createElement("li");
          li.className = "list-group-item";
          if (d.editing) {
            li.innerHTML = `...`; // 留下你原有的修改表單代碼
          } else {
            li.innerHTML = `
              <div>
                <strong>藥名：</strong>${d.name}<br>
                <strong>適應症：</strong>${d.indication}<br>
                <strong>副作用：</strong>${d.sideEffect}<br>
                <strong>特殊用藥指示：</strong>${d.specialInstruction}<br>
                <strong>藥物保存方式：</strong>${d.storage}<br>
                <strong>應急就醫時機：</strong>${d.emergencyGuideline}
              </div>
              <div class="mt-2 text-end">
                <button class="btn btn-warning btn-sm me-1" onclick="editDrug('${doc.id}')">修改</button>
                <button class="btn btn-danger btn-sm" onclick="deleteDrug('${doc.id}')">刪除</button>
              </div>`;
          }
          list.appendChild(li);
        });
    }

    drugsRef.orderBy("name").onSnapshot(snapshot => {
      drugCache = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        drugCache.push({ id: doc.id, data });
      });
      renderDrugs();
    });
  </script>
</body>
</html>
