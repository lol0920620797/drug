<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>è—¥ç‰©æ¸…å–®ç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts for Chinese -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans TC', sans-serif;
    }

    .preview-img {
      max-height: 60px;
      margin-top: 4px;
    }

    th,
    td {
      vertical-align: middle !important;
    }

    body,
    table,
    td,
    th,
    h1,
    h2,
    h3 {
      font-family: 'Noto Sans TC', sans-serif !important;
    }
  </style>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


</head>

<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">ğŸ’Š è—¥ç‰©æ¸…å–®ç®¡ç†ç³»çµ±</h1>

    <!-- åŒ¯å‡º PDF æŒ‰éˆ• & æœå°‹æ¬„ -->
    <div class="mb-3 row g-2">
      <div class="col-12 col-md-6">
        <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” æœå°‹è—¥å“é—œéµå­—" oninput="renderDrugs()">
      </div>
      <div class="col-12 col-md-6 text-md-end">
        <button class="btn btn-outline-primary w-100 w-md-auto" onclick="exportPDF()">åŒ¯å‡º PDFï¼ˆåƒ…å‹¾é¸ï¼‰</button>
      </div>
    </div>


    <!-- æ–°å¢è—¥å“è¡¨å–® -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <input type="text" id="name" class="form-control" placeholder="è—¥åï¼ˆå¿…å¡«ï¼‰">
          </div>
          <div class="col-12 col-md-4">
            <input type="text" id="indication" class="form-control" placeholder="é©æ‡‰ç—‡">
          </div>
          <div class="col-12 col-md-4">
            <input type="text" id="sideEffect" class="form-control" placeholder="å‰¯ä½œç”¨">
          </div>
          <div class="col-12 col-md-6">
            <input type="text" id="specialInstruction" class="form-control" placeholder="ç‰¹æ®Šç”¨è—¥æŒ‡ç¤º">
          </div>
          <div class="col-12 col-md-6">
            <input type="text" id="storage" class="form-control" placeholder="ä¿å­˜æ–¹å¼">
          </div>
          <div class="col-12">
            <input type="text" id="emergencyGuideline" class="form-control" placeholder="æ‡‰æ€¥æ™‚æ©Ÿ">
          </div>
          <div class="text-center">
            <button class="btn btn-primary" onclick="addDrug()">æ–°å¢è—¥ç‰©</button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ¸…å–®å€å¡Š -->
    <div class="table-responsive">
      <table class="table table-bordered bg-white align-middle text-center" id="drugTable">
        <thead class="table-secondary">
          <tr>
            <th><input type="checkbox" id="selectAll" onchange="toggleAll(this.checked)"> å…¨é¸</th>
            <th>è—¥å</th>
            <th>é©æ‡‰ç—‡</th>
            <th>å‰¯ä½œç”¨</th>
            <th>ç‰¹æ®Šç”¨è—¥æŒ‡ç¤º</th>
            <th>ä¿å­˜æ–¹å¼</th>
            <th>æ‡‰æ€¥æ™‚æ©Ÿ</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="drugList"></tbody>
      </table>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBI6nbcytrLY15EUi8CBVGDK6GNlgPhSD4",
        authDomain: "druglistapp-9590d.firebaseapp.com",
        projectId: "druglistapp-9590d"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const drugsRef = db.collection("drugs");

      let drugCache = [];
      let selectedIds = new Set();
      let imageBase64 = "";

      // function previewImage(event) {
      //   const reader = new FileReader();
      //   reader.onload = function (e) {
      //     imageBase64 = e.target.result;
      //     document.getElementById("preview").src = imageBase64;
      //   };
      //   reader.readAsDataURL(event.target.files[0]);
      // }

      function toggleAll(checked) {
        const checkboxes = document.querySelectorAll("#drugList input[type='checkbox']");
        checkboxes.forEach(cb => {
          cb.checked = checked;
          const id = cb.getAttribute("data-id");
          if (checked) selectedIds.add(id);
          else selectedIds.delete(id);
        });
      }

      function addDrug() {
        const data = {
          name: document.getElementById("name").value.trim(),
          indication: document.getElementById("indication").value.trim(),
          sideEffect: document.getElementById("sideEffect").value.trim(),
          specialInstruction: document.getElementById("specialInstruction").value.trim(),
          storage: document.getElementById("storage").value.trim(),
          emergencyGuideline: document.getElementById("emergencyGuideline").value.trim(),
          image: imageBase64 || ""
        };
        if (!data.name) return Swal.fire("è—¥åæœªå¡«", "è«‹è‡³å°‘å¡«å¯«è—¥å", "warning");
        drugsRef.add(data).then(() => {
          Swal.fire("æ–°å¢æˆåŠŸ", "è—¥ç‰©å·²åŠ å…¥æ¸…å–®", "success");
          document.querySelectorAll("input").forEach(input => input.value = "");
          document.getElementById("preview").src = "";
          imageBase64 = "";
        });
      }

      function toggleSelect(id, checked) {
        if (checked) selectedIds.add(id);
        else selectedIds.delete(id);
      }

      function renderDrugs() {
        const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
        const list = document.getElementById("drugList");
        list.innerHTML = "";


        drugCache.filter(doc => {
          const d = doc.data;
          return (
            d.name + d.indication + d.sideEffect + d.specialInstruction + d.storage + d.emergencyGuideline
          ).toLowerCase().includes(keyword);
        }).forEach(doc => {
          const d = doc.data;
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td><input type="checkbox" data-id="${doc.id}" onchange="toggleSelect('${doc.id}', this.checked)" ${selectedIds.has(doc.id) ? "checked" : ""}></td>
            <td>${d.name}</td>
            <td>${d.indication}</td>
            <td>${d.sideEffect}</td>
            <td>${d.specialInstruction}</td>
            <td>${d.storage}</td>
            <td>${d.emergencyGuideline}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="editDrug('${doc.id}')">ä¿®æ”¹</button>
              <button class="btn btn-sm btn-danger" onclick="deleteDrug('${doc.id}')">åˆªé™¤</button>
            </td>
          `;
          list.appendChild(tr);
        });

      }

      function editDrug(id) {
        const drug = drugCache.find(doc => doc.id === id);
        if (!drug) return;
        const data = drug.data;
        Swal.fire({
          title: 'ä¿®æ”¹è—¥ç‰©',
          html: `
            <input id="swal-name" class="swal2-input" placeholder="è—¥å" value="${data.name || ''}">
            <input id="swal-indication" class="swal2-input" placeholder="é©æ‡‰ç—‡" value="${data.indication || ''}">
            <input id="swal-side" class="swal2-input" placeholder="å‰¯ä½œç”¨" value="${data.sideEffect || ''}">
            <input id="swal-special" class="swal2-input" placeholder="ç‰¹æ®Šç”¨è—¥æŒ‡ç¤º" value="${data.specialInstruction || ''}">
            <input id="swal-storage" class="swal2-input" placeholder="ä¿å­˜æ–¹å¼" value="${data.storage || ''}">
            <input id="swal-emergency" class="swal2-input" placeholder="æ‡‰æ€¥æ™‚æ©Ÿ" value="${data.emergencyGuideline || ''}">
          `,
          focusConfirm: false,
          preConfirm: () => {
            return {
              name: document.getElementById('swal-name').value,
              indication: document.getElementById('swal-indication').value,
              sideEffect: document.getElementById('swal-side').value,
              specialInstruction: document.getElementById('swal-special').value,
              storage: document.getElementById('swal-storage').value,
              emergencyGuideline: document.getElementById('swal-emergency').value,
              image: data.image || ""
            }
          }
        }).then(result => {
          if (result.isConfirmed) {
            drugsRef.doc(id).update(result.value).then(() => {
              Swal.fire('ä¿®æ”¹æˆåŠŸ', '', 'success');
            });
          }
        });
      }

      function deleteDrug(id) {
        Swal.fire({
          title: 'ç¢ºå®šåˆªé™¤ï¼Ÿ',
          text: 'æ­¤æ“ä½œç„¡æ³•å¾©åŸ',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'åˆªé™¤',
          cancelButtonText: 'å–æ¶ˆ'
        }).then(result => {
          if (result.isConfirmed) {
            drugsRef.doc(id).delete().then(() => {
              Swal.fire('å·²åˆªé™¤', '', 'success');
            });
          }
        });
      }

      drugsRef.orderBy("name").onSnapshot(snapshot => {
        drugCache = [];
        snapshot.forEach(doc => drugCache.push({ id: doc.id, data: doc.data() }));
        renderDrugs();
      });

      async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const selectedDrugs = drugCache.filter(doc => selectedIds.has(doc.id));
        if (selectedDrugs.length === 0) {
          return Swal.fire("æœªå‹¾é¸", "è«‹è‡³å°‘å‹¾é¸ä¸€ç­†è—¥å“", "info");
        }

        // ğŸ› ï¸ ç”¨ innerHTML æ‹¼å‡ºå®Œæ•´ DOM
        const temp = document.createElement("div");
        temp.style.padding = "10px";
        temp.style.fontFamily = "'Noto Sans TC', sans-serif";
        temp.style.width = "794px"; // A4 å°ºå¯¸å°æ‡‰ width (for canvas)
        temp.style.background = "white";

        // æ‰‹å·¥æ‹¼æ•´å€‹ innerHTML
        temp.innerHTML = `
    <div style="text-align:center; margin-bottom: 10px;">
  <img src="imgs/å°ˆå¿ƒlogo.png" style="max-height: 60px;" />å°ˆå¿ƒå‹•ç‰©é†«é™¢
</div>
    <div style="text-align:center; font-size: 15px; margin-bottom: 10px;">åœ°å€ï¼šå°åŒ—å¸‚ä¸­æ­£å€ä»æ„›è·¯ä¸€æ®µ47è™Ÿ  é›»è©±ï¼š02-23633016</div>
    <div style="text-align:left; font-size: 13px; margin-bottom: 10px;">åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString("zh-TW", { hour12: false })}</div>

    <table style="width:100%; border-collapse:collapse; font-size: 13px;" border="1">
      <thead style="background:#eee;">
        <tr>
          <th style="padding:4px;">è—¥å</th>
          <th style="padding:4px;">é©æ‡‰ç—‡</th>
          <th style="padding:4px;">å‰¯ä½œç”¨</th>
          <th style="padding:4px;">ç‰¹æ®Šç”¨è—¥æŒ‡ç¤º</th>
          <th style="padding:4px;">ä¿å­˜æ–¹å¼</th>
          <th style="padding:4px;">æ‡‰æ€¥æ™‚æ©Ÿ</th>
        </tr>
      </thead>
      <tbody>
        ${selectedDrugs.map(d => {
          const data = d.data;
          return `<tr>
            <td style="padding:4px;">${data.name}</td>
            <td style="padding:4px;">${data.indication}</td>
            <td style="padding:4px;">${data.sideEffect}</td>
            <td style="padding:4px;">${data.specialInstruction}</td>
            <td style="padding:4px;">${data.storage}</td>
            <td style="padding:4px;">${data.emergencyGuideline}</td>
          </tr>`;
        }).join("")}
      </tbody>
    </table>

    <div style="text-align:right; font-size: 10px; margin-top:10px;">Â© é…·å“¥é˜¿é‚±</div>
  `;

        // åŠ é€²ç•«é¢å¤–ã€æº–å‚™æ¸²æŸ“
        document.body.appendChild(temp);

        // è½‰ç‚ºåœ–ç‰‡
        const canvas = await html2canvas(temp, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        // åŠ å…¥åœ–ç‰‡é€² PDF
        doc.addImage(imgData, "PNG", 14, 14, pdfWidth - 28, pdfHeight);
        doc.save("å‹¾é¸è—¥ç‰©æ¸…å–®.pdf");

        // æ¸…æ‰è‡¨æ™‚ DOM
        document.body.removeChild(temp);
      }



    </script>
  </div>
</body>

</html>