<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è—¥ç‰©æ¸…å–®ç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>

<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">ğŸ’Š è—¥ç‰©æ¸…å–®ç®¡ç†ç³»çµ±</h1>

    <!-- ğŸ” æœå°‹è—¥å -->
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” è«‹è¼¸å…¥è—¥åé€²è¡Œæœå°‹" oninput="renderDrugs()">
    </div>

    <!-- æ–°å¢è¡¨å–® -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4"><input type="text" id="name" class="form-control" placeholder="è—¥å"></div>
          <div class="col-md-4"><input type="text" id="indication" class="form-control" placeholder="é©æ‡‰ç—‡"></div>
          <div class="col-md-4"><input type="text" id="sideEffect" class="form-control" placeholder="å‰¯ä½œç”¨"></div>
          <div class="col-md-6"><input type="text" id="specialInstruction" class="form-control" placeholder="ç‰¹æ®Šç”¨è—¥æŒ‡ç¤º"></div>
          <div class="col-md-6"><input type="text" id="storage" class="form-control" placeholder="è—¥ç‰©ä¿å­˜æ–¹å¼"></div>
          <div class="col-md-12"><input type="text" id="emergencyGuideline" class="form-control" placeholder="æ‡‰æ€¥å°±é†«æ™‚æ©Ÿ"></div>
          <div class="col-md-12 d-grid"><button class="btn btn-primary" onclick="addDrug()">æ–°å¢è—¥ç‰©</button></div>
        </div>
      </div>
    </div>

    <!-- æ¸…å–® -->
    <ul class="list-group" id="drugList"></ul>
  </div>

  <script>
    // âœ… ä½ çš„ firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyBI6nbcytrLY15EUi8CBVGDK6GNlgPhSD4",
      authDomain: "druglistapp-9590d.firebaseapp.com",
      projectId: "druglistapp-9590d",
      storageBucket: "druglistapp-9590d.appspot.com",
      messagingSenderId: "779715592474",
      appId: "1:779715592474:web:e83197b85f06afab90aca3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const drugsRef = db.collection("drugs");

    let drugCache = [];

    function addDrug() {
      const data = {
        name: document.getElementById("name").value.trim(),
        indication: document.getElementById("indication").value.trim(),
        sideEffect: document.getElementById("sideEffect").value.trim(),
        specialInstruction: document.getElementById("specialInstruction").value.trim(),
        storage: document.getElementById("storage").value.trim(),
        emergencyGuideline: document.getElementById("emergencyGuideline").value.trim()
      };
      if (!data.name || !data.indication) return alert("è«‹è‡³å°‘å¡«å¯«è—¥åèˆ‡é©æ‡‰ç—‡");
      drugsRef.add(data).then(clearForm);
    }

    function clearForm() {
      ["name", "indication", "sideEffect", "specialInstruction", "storage", "emergencyGuideline"].forEach(id => {
        document.getElementById(id).value = "";
      });
    }

    function renderDrugs() {
      const list = document.getElementById("drugList");
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      list.innerHTML = "";

      drugCache
        .filter(doc => doc.data.name.toLowerCase().includes(keyword))
        .forEach(doc => {
          const d = doc.data;
          const li = document.createElement("li");
          li.className = "list-group-item";
          if (d.editing) {
            li.innerHTML = `
              <div class="row g-2">
                <div class="col-md-4"><input class="form-control" id="editName${doc.id}" value="${d.name}"></div>
                <div class="col-md-4"><input class="form-control" id="editIndication${doc.id}" value="${d.indication}"></div>
                <div class="col-md-4"><input class="form-control" id="editSideEffect${doc.id}" value="${d.sideEffect}"></div>
                <div class="col-md-6"><input class="form-control" id="editSpecial${doc.id}" value="${d.specialInstruction}"></div>
                <div class="col-md-6"><input class="form-control" id="editStorage${doc.id}" value="${d.storage}"></div>
                <div class="col-md-12"><input class="form-control" id="editEmergency${doc.id}" value="${d.emergencyGuideline}"></div>
                <div class="col-md-12 text-end mt-2">
                  <button class="btn btn-success btn-sm me-1" onclick="saveEdit('${doc.id}')">å„²å­˜</button>
                  <button class="btn btn-secondary btn-sm" onclick="cancelEdit('${doc.id}')">å–æ¶ˆ</button>
                </div>
              </div>`;
          } else {
            li.innerHTML = `
              <div>
                <strong>è—¥åï¼š</strong>${d.name}<br>
                <strong>é©æ‡‰ç—‡ï¼š</strong>${d.indication}<br>
                <strong>å‰¯ä½œç”¨ï¼š</strong>${d.sideEffect}<br>
                <strong>ç‰¹æ®Šç”¨è—¥æŒ‡ç¤ºï¼š</strong>${d.specialInstruction}<br>
                <strong>è—¥ç‰©ä¿å­˜æ–¹å¼ï¼š</strong>${d.storage}<br>
                <strong>æ‡‰æ€¥å°±é†«æ™‚æ©Ÿï¼š</strong>${d.emergencyGuideline}
              </div>
              <div class="mt-2 text-end">
                <button class="btn btn-warning btn-sm me-1" onclick="editDrug('${doc.id}')">ä¿®æ”¹</button>
                <button class="btn btn-danger btn-sm" onclick="deleteDrug('${doc.id}')">åˆªé™¤</button>
              </div>`;
          }
          list.appendChild(li);
        });
    }

    function editDrug(id) {
      const index = drugCache.findIndex(d => d.id === id);
      if (index !== -1) {
        drugCache[index].data.editing = true;
        renderDrugs();
      }
    }

    function cancelEdit(id) {
      const index = drugCache.findIndex(d => d.id === id);
      if (index !== -1) {
        drugCache[index].data.editing = false;
        renderDrugs();
      }
    }

    function saveEdit(id) {
      const updateData = {
        name: document.getElementById(`editName${id}`).value.trim(),
        indication: document.getElementById(`editIndication${id}`).value.trim(),
        sideEffect: document.getElementById(`editSideEffect${id}`).value.trim(),
        specialInstruction: document.getElementById(`editSpecial${id}`).value.trim(),
        storage: document.getElementById(`editStorage${id}`).value.trim(),
        emergencyGuideline: document.getElementById(`editEmergency${id}`).value.trim()
      };
      drugsRef.doc(id).update(updateData);
    }

    function deleteDrug(id) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è—¥ç‰©è³‡æ–™ï¼Ÿ")) {
        drugsRef.doc(id).delete();
      }
    }

    // åˆå§‹è¼‰å…¥ + ç›£è½è³‡æ–™
    drugsRef.orderBy("name").onSnapshot(snapshot => {
      drugCache = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        drugCache.push({ id: doc.id, data });
      });
      renderDrugs();
    });
  </script>
</body>
</html>
